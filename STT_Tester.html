<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deepgram STT Diagnostic Tool</title>
    <style>
        body { font-family: system-ui, sans-serif; max-width: 600px; margin: 2rem auto; padding: 0 1rem; line-height: 1.5; background: #f4f7f6; }
        .card { background: white; padding: 2rem; border-radius: 12px; shadow: 0 4px 6px rgba(0,0,0,0.1); border: 1px solid #ddd; }
        input, select, button { width: 100%; padding: 0.8rem; margin: 0.5rem 0; border-radius: 6px; border: 1px solid #ccc; font-size: 1rem; }
        button { background: #007bff; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:disabled { background: #ccc; }
        #status { font-weight: bold; color: #555; margin: 1rem 0; }
        #result { background: #e9ecef; padding: 1rem; border-radius: 6px; min-height: 50px; white-space: pre-wrap; border-left: 5px solid #007bff; font-size: 1.2rem; }
        .debug { font-size: 0.8rem; color: #666; margin-top: 1rem; font-family: monospace; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="card">
        <h2>üéôÔ∏è Deepgram STT Tester</h2>
        <p>Test raw Nova-3 accuracy without AI logic.</p>
        
        <label>Deepgram API Key:</label>
        <input type="password" id="apiKey" placeholder="Paste your key here..." value="">
        
        <label>Language:</label>
        <select id="lang">
            <option value="te">Telugu (Native Script)</option>
            <option value="hi">Hindi (Devanagari)</option>
            <option value="en">English (India)</option>
        </select>
        
        <button id="startBtn">üî¥ Start Recording (Speak for 5s)</button>
        <button id="stopBtn" disabled>‚èπÔ∏è Stop & Transcribe</button>
        
        <div id="status">Status: Ready</div>
        
        <h3>Final Result:</h3>
        <div id="result">Waiting for audio...</div>

        <h3>Raw Debug Trace:</h3>
        <div id="debug" class="debug">Log: </div>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const status = document.getElementById('status');
        const resultDiv = document.getElementById('result');
        const debugDiv = document.getElementById('debug');

        const log = (msg) => {
            debugDiv.innerText += "\n> " + msg;
            console.log(msg);
        };

        startBtn.onclick = async () => {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
            audioChunks = [];
            
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = async () => {
                const blob = new Blob(audioChunks, { type: 'audio/webm;codecs=opus' });
                await sendToDeepgram(blob);
            };

            mediaRecorder.start();
            startBtn.disabled = true;
            stopBtn.disabled = false;
            status.innerText = "Status: üéôÔ∏è Recording... Speak now!";
            log("Recording started...");
        };

        stopBtn.onclick = () => {
            mediaRecorder.stop();
            startBtn.disabled = false;
            stopBtn.disabled = true;
            status.innerText = "Status: ‚è≥ Processing...";
        };

        async function sendToDeepgram(blob) {
            const key = document.getElementById('apiKey').value;
            const lang = document.getElementById('lang').value;
            
            if (!key) {
                alert("Please enter an API Key");
                return;
            }

            log(`Sending ${blob.size} bytes to Deepgram (Nova-3, Lang: ${lang})...`);

            const url = `https://api.deepgram.com/v1/listen?model=nova-3&language=${lang}&smart_format=false&punctuate=true`;
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Token ${key}`,
                        'Content-Type': 'audio/webm;codecs=opus'
                    },
                    body: blob
                });

                const data = await response.json();
                const text = data.results.channels[0].alternatives[0].transcript;
                
                resultDiv.innerText = text || "(No words recognized)";
                status.innerText = "Status: ‚úÖ Done!";
                log("Response: " + JSON.stringify(data).substring(0, 200) + "...");
            } catch (err) {
                status.innerText = "Status: ‚ùå Error";
                log("Error: " + err.message);
            }
        }
    </script>
</body>
</html>
